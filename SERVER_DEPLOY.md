# Деплой TGPlay на VPS — без сна, до сотен запросов, из России

Один скрипт ставит бэкенд, туннель (localhost.run) и бота на Ubuntu. После перезагрузки сервера всё поднимается само (systemd). Подходит для любого VPS с **Ubuntu 22.04**.

**Почему не Oracle и не Yandex Cloud:** с территории РФ Oracle Cloud часто недоступен (регистрация/карты); Yandex Cloud — жёсткие лимиты и риски блокировок/санкций. Ниже варианты, которые нормально работают из России.

---

## 1. Где взять VPS (из России, без лишних рисков)

Бесплатного 24/7 VPS из РФ почти нет. Реалистичный вариант — **недорогой VPS** (от ~100–300 ₽/мес), оплата картой РФ, без санкционных сюрпризов.

### Российские хостинги (рубли, без санкций)

| Провайдер | Сайт | Примерно | Плюсы |
|-----------|------|----------|--------|
| **Selectel** | [selectel.ru](https://selectel.ru) | от ~200 ₽/мес | Надёжно, есть тарифы под маленькие проекты |
| **Timeweb** | [timeweb.com](https://timeweb.com) | от ~200 ₽/мес | Удобная панель, VPS за копейки |
| **RUVDS** | [ruvds.com](https://ruvds.com) | от ~100 ₽/мес | Очень дёшево, оплата картой РФ |
| **FirstVDS** | [firstvds.ru](https://firstvds.ru) | от ~150 ₽/мес | Российский хостинг, без блокировок из РФ |

Что сделать: зайти на сайт → создать VPS с **Ubuntu 22.04**, 1 vCPU и 1 GB RAM хватит для сотен одновременных запросов. В firewall/панели открыть порт **22** (SSH). Запомнить **публичный IP** и логин (часто `root` или `ubuntu`).

### Если готов платить в евро: Hetzner

[Hetzner](https://www.hetzner.com) — от ~4 €/мес, из РФ обычно доступен, оплата картой. Создаёшь Cloud Server, образ Ubuntu 22.04, открываешь SSH (22).

---

## 2. Подключение и подготовка проекта

Подключись по SSH (подставь свой IP и пользователя — часто `root` или `ubuntu`):

```bash
ssh root@ПУБЛИЧНЫЙ_IP
```

или, если выдали отдельного пользователя:

```bash
ssh ubuntu@ПУБЛИЧНЫЙ_IP
```

Установи git (если ещё нет) и склонируй проект:

```bash
sudo apt update && sudo apt install -y git
git clone https://github.com/dirtyworker666x/telegram-music-miniapp.git
cd telegram-music-miniapp
```

Если репозиторий свой — замени URL на свой.

---

## 3. Настройка .env (один раз)

Скопируй пример и отредактируй — укажи **BOT_TOKEN** и **VK_TOKEN** (и при желании VK_USER_AGENT):

```bash
cp backend/.env.example backend/.env
nano backend/.env
```

Обязательно заполни:

- `BOT_TOKEN=...` — токен от @BotFather.
- `VK_TOKEN=...` — токен VK (например, с [vkhost.github.io](https://vkhost.github.io), пункт «VK Admin»).
- `VK_USER_AGENT=VKAndroidApp/5.52-4543` — можно оставить как есть.

Поле **WEBAPP_URL** можно не трогать: его при старте подставит скрипт туннеля (watchdog) в этот же файл.

Сохрани файл (в nano: Ctrl+O, Enter, Ctrl+X).

---

## 4. Запуск установки (одна команда)

От корня проекта выполни:

```bash
sudo bash scripts/setup-server-ubuntu.sh
```

Скрипт:

- поставит Node.js 18, Python3, ffmpeg, openssh-client;
- создаст виртуальное окружение бэкенда и установит зависимости;
- соберёт фронт (`npm run build`);
- создаст и запустит два сервиса systemd:
  - **tgplay-backend** — FastAPI на порту 8787;
  - **tgplay-tunnel** — туннель localhost.run + бот (watchdog).

Через 10–15 секунд туннель выдаст HTTPS-адрес; он автоматически запишется в `backend/.env` как `WEBAPP_URL`. Бот будет использовать его для кнопки «Открыть плеер».

---

## 5. Проверка и где смотреть логи

Проверить, что оба сервиса работают:

```bash
systemctl status tgplay-backend tgplay-tunnel
```

Лог туннеля (здесь же появится актуальный WEBAPP_URL):

```bash
journalctl -u tgplay-tunnel.service -f
```

Выйти из лога: Ctrl+C.

Убедиться, что бэкенд отвечает (после того как в логе туннеля появился URL):

```bash
curl -s https://ТВОЙ_URL_ИЗ_ЛОГА/api/status
```

Должен вернуться JSON со статусом.

---

## 6. Поведение после перезагрузки

Сервисы включены в автозагрузку: после перезагрузки VPS бэкенд и туннель+бот поднимутся сами. Действовать вручную не нужно.

Перезапуск вручную:

```bash
sudo systemctl restart tgplay-backend tgplay-tunnel
```

---

## Нагрузка и лимиты

- VPS на 1 vCPU и 1 GB RAM спокойно держит **сотни одновременных запросов** (в коде уже задано `limit_concurrency=200` и кеширование).
- Туннель localhost.run на сервере обычно стабильнее, чем с домашнего ПК; при обрыве watchdog перезапустит туннель и бота сам.

---

## Кратко по шагам

1. Взять VPS (Selectel, Timeweb, RUVDS, FirstVDS или Hetzner), Ubuntu 22.04, открыть порт 22 (SSH).
2. Подключиться по SSH, склонировать репозиторий, заполнить `backend/.env` (BOT_TOKEN, VK_TOKEN).
3. Выполнить: `sudo bash scripts/setup-server-ubuntu.sh`.
4. Посмотреть в логе туннеля URL и проверить в браузере/боте — после этого всё работает без твоего участия, перезагрузки сервера переживает само.
